# Upload Service

Сервис отвечает за приём исходных аудиотреков и подготовку их к дальнейшей обработке. Ниже описано, как он взаимодействует с остальными компонентами платформы.

## Внешнее взаимодействие

1. **gRPC клиент**

   - Клиент устанавливает стрим с методом `UploadService.UploadTrack`.
   - Первая gRPC-структура содержит метаданные трека (`artist_ids[]`, `track_name`, `genre`).
   - Все последующие сообщения — это бинарные чанки файла, которые сервис объединяет в единый буфер.

2. **Track Service (CreateTrack)**

   - После получения данных сервис рассчитывает длительность аудио и по gRPC вызывает метод `TrackService.CreateTrack`.
   - В `CreateTrackRequest` передаются `name` (оригинальное имя файла), массив `artist_ids`, `genre`, а также рассчитанный `duration`.
   - В ответ на `CreateTrackResponse` приходит `track_id`, который используется как уникальный идентификатор для хранения и последующих операций.

3. **MinIO хранилище**

   - Полученный файл сохраняется в MinIO в пространстве вида `<artist_ids[0]>/track_id/original/` (используется первый идентификатор).
   - URL загруженного объекта формируется относительно настроек MinIO (по умолчанию `http://minio:9000/<bucket>/<object>`).

4. **Очередь транскодера (Redpanda/Kafka)**
   - Финальный шаг — публикация задачи в топик транскодера.
   - Сообщение содержит `track_id`, основной `artist_id` (тот, что использовался для пути в MinIO) и `track_url`. Транскодер скачивает оригинал по ссылке, обрабатывает его и уже после этого вызывает Track Service для обновления `storage_url` и других полей.

Такой порядок взаимодействия гарантирует, что информация о треке появляется в Track Service до загрузки файла, а ссылка на оригинал доставляется до транскодера, который затем обновляет Track Service по завершении обработки.

## Ответ сервиса

По завершении обработки gRPC-сервер закрывает стрим с ответом формата:

- `success` — булево значение, отражающее результат операции;
- `message` — текстовое описание (например, `"Track uploaded successfully"`);
- `track_id` — идентификатор трека, полученный от Track Service на этапе создания.

Если на любом этапе (получение данных, обращение к Track Service, загрузка в MinIO, отправка задачи в очередь) возникает ошибка, сервер не отправляет `UploadTrackResponse`, а возвращает gRPC-ошибку. Клиент получит статус (например, `INTERNAL`) с текстом ошибки и должен обработать его самостоятельно.
