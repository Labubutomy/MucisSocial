# Upload Service

Сервис отвечает за приём исходных аудиотреков и подготовку их к дальнейшей обработке. Ниже описано, как он взаимодействует с остальными компонентами платформы.

## Внешнее взаимодействие

1. **gRPC клиент**

   - Клиент устанавливает стрим с методом `UploadService.UploadTrack`.
   - Первая gRPC-структура содержит метаданные трека (`artist_id`, `track_name`).
   - Все последующие сообщения — это бинарные чанки файла, которые сервис объединяет в единый буфер.

2. **Track Service (CreateTrack)**

   - После получения данных сервис рассчитывает длительность аудио и по gRPC вызывает метод `TrackService.CreateTrack`.
   - В `CreateTrackRequest` передаются `artist_id`, `name` (оригинальное имя файла) и рассчитанный `duration`.
   - В ответ на `CreateTrackResponse` приходит `track_id`, который используется как уникальный идентификатор для хранения и последующих операций.

3. **MinIO хранилище**

   - Полученный файл сохраняется в MinIO в пространстве вида `artist_id/track_id/original/`.
   - URL загруженного объекта формируется относительно настроек MinIO (по умолчанию `http://minio:9000/<bucket>/<object>`).

4. **Track Service (UpdateTrackLocation)**

   - Далее по gRPC вызывается метод `TrackService.UpdateTrackLocation`.
   - В `UpdateTrackLocationRequest` сервис передаёт `track_id` и сгенерированный `storage_url`.
   - Это делает исходный файл доступным для дальнейших внутренних сервисов.

5. **Очередь транскодера (Redpanda/Kafka)**
   - Финальный шаг — публикация задачи в топик транскодера.
   - Сообщение содержит `track_id`, `artist_id` и `track_url`, что инициирует дальнейшую обработку и генерацию производных форматов.

Такой порядок взаимодействия гарантирует, что информация о треке появляется в Track Service до загрузки файла, и все downstream-системы получают валидный идентификатор и ссылку на исходник.

## Ответ сервиса

По завершении обработки gRPC-сервер закрывает стрим с ответом формата:

- `success` — булево значение, отражающее результат операции;
- `message` — текстовое описание (например, `"Track uploaded successfully"`);
- `track_id` — идентификатор трека, полученный от Track Service на этапе создания.

Если на любом этапе (получение данных, обращение к Track Service, загрузка в MinIO, отправка задачи в очередь) возникает ошибка, сервер не отправляет `UploadTrackResponse`, а возвращает gRPC-ошибку. Клиент получит статус (например, `INTERNAL`) с текстом ошибки и должен обработать его самостоятельно.
